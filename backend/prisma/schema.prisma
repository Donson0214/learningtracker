// NOTE: Schema is frozen; update only via migrations.
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////////
// ENUMS
////////////////////////

enum UserRole {
  LEARNER
  ORG_ADMIN
  SYSTEM_ADMIN
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

////////////////////////
// CORE MODELS
////////////////////////

model User {
  id          String   @id @default(uuid())
  firebaseUid String   @unique
  email       String   @unique
  name        String?
  role        UserRole @default(LEARNER)
  dailyReminderEnabled Boolean @default(true)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  studySessions StudySession[]
  studyGoals    StudyGoal[]
  studyPlans    StudyPlan[]
  lessonProgresses LessonProgress[]
  notifications Notification[]
  enrollments   Enrollment[]
  deviceTokens  DeviceToken[]
  invitesSent   OrganizationInvite[] @relation("InvitesSent")
  invitesAccepted OrganizationInvite[] @relation("InvitesAccepted")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Organization {
  id       String  @id @default(uuid())
  name     String
  isActive Boolean @default(true)

  users   User[]
  courses Course[]
  invites OrganizationInvite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

////////////////////////
// COURSE STRUCTURE
////////////////////////

model Course {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  title          String
  description    String?
  estimatedHours Int?

  modules        Module[]
  enrollments    Enrollment[]
  studySessions  StudySession[]
  studyPlanItems StudyPlanItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrganizationInvite {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  email     String
  role      UserRole     @default(LEARNER)
  tokenHash String       @unique
  status    InviteStatus @default(PENDING)

  invitedById String
  invitedBy   User   @relation("InvitesSent", fields: [invitedById], references: [id])
  acceptedById String?
  acceptedBy   User? @relation("InvitesAccepted", fields: [acceptedById], references: [id])

  createdAt DateTime @default(now())
  expiresAt DateTime
  acceptedAt DateTime?
  revokedAt  DateTime?

  @@index([organizationId, email])
}

model Module {
  id       String @id @default(uuid())
  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  title String
  order Int

  lessons        Lesson[]
  studySessions  StudySession[]
  studyPlanItems StudyPlanItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lesson {
  id       String @id @default(uuid())
  moduleId String
  module   Module @relation(fields: [moduleId], references: [id])

  title            String
  estimatedMinutes Int
  lessonProgresses LessonProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LessonProgress {
  id       String @id @default(uuid())
  userId   String
  lessonId String
  completedAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

////////////////////////
// ENROLLMENTS
////////////////////////

model Enrollment {
  id       String @id @default(uuid())
  userId   String
  courseId String

  user   User   @relation(fields: [userId], references: [id])
  course Course @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, courseId])
}

////////////////////////
// STUDY TRACKING
////////////////////////

model StudySession {
  id       String  @id @default(uuid())
  userId   String
  courseId String
  moduleId String?

  durationMinutes Int
  notes           String?
  mood            String?
  studiedAt       DateTime

  user   User    @relation(fields: [userId], references: [id])
  course Course  @relation(fields: [courseId], references: [id])
  module Module? @relation(fields: [moduleId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId, studiedAt])
}

model StudyGoal {
  id     String @id @default(uuid())
  userId String

  hoursPerWeek       Int
  targetCompletionAt DateTime?

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

////////////////////////
// STUDY PLANS (AI)
////////////////////////

model StudyPlan {
  id     String @id @default(uuid())
  userId String

  startDate DateTime
  endDate   DateTime

  user  User            @relation(fields: [userId], references: [id])
  items StudyPlanItem[]

  createdAt DateTime @default(now())
}

model StudyPlanItem {
  id          String @id @default(uuid())
  studyPlanId String

  courseId String
  moduleId String?

  scheduledDate   DateTime
  durationMinutes Int
  isCompleted     Boolean  @default(false)

  studyPlan StudyPlan @relation(fields: [studyPlanId], references: [id])
  course    Course    @relation(fields: [courseId], references: [id])
  module    Module?   @relation(fields: [moduleId], references: [id])
}

////////////////////////
// NOTIFICATIONS
////////////////////////

model Notification {
  id     String @id @default(uuid())
  userId String

  title  String
  body   String
  isRead Boolean @default(false)

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

////////////////////////
// DEVICE TOKENS (FCM)
////////////////////////

model DeviceToken {
  id     String @id @default(uuid())
  userId String
  token  String

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, token])
}
